variant: flatcar
version: 1.0.0
storage:
  filesystems:
    - device: /dev/sdb
      format: ext4
      label: data1
  directories:
    - path: /mnt/data/bitcoin
      mode: 0755
      user:
        name: bitcoind
      group:
        name: bitcoind
    - path: /mnt/data/electrs
      mode: 0755
      user:
        name: electrs
      group:
        name: electrs
  files:
    - path: /etc/bitcoin/bitcoin.conf
      contents:
        local: bitcoin/bitcoin.conf
    - path: /etc/electrs/config.toml
      contents:
        local: electrs/config.toml
    # - path: /etc/extensions/bitcoin.raw
    #   mode: 0644
    #   contents:
    #     source: https://filebin.net/8smw1ra4g22u1xk8/bitcoin.raw
passwd:
  users:
    - name: marvin.vogt
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOELWzSrWOfYX4B7v0kYnIyQT3M3wVV1c6X+LpoJFDcI
      groups: [sudo, docker]
    - name: bitcoind
      system: true
      no_create_home: true
    - name: electrs
      system: true
      no_create_home: true
systemd:
  units:
    - name: mnt-data.mount
      enabled: true
      contents: |
        [Unit]
        Description=Data mount

        [Mount]
        What=/dev/disk/by-label/data1
        Where=/mnt/data
        Type=ext4

        [Install]
        WantedBy=multi-user.target
    - name: docker.service
      enabled: true
    - name: electrs.service
      enabled: false
      contents: |
        [Unit]
        Description=Electrs electrum server
        Requires=bitcoind.service
        Requires=mnt-data.mount

        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker rm --force electrs
        ExecStart=/usr/bin/docker run \
            --name electrs \
            --pull always \
            -v /etc/electrs:/etc/electrs:ro \
            -v /mnt/data/electrs:/mnt/data/electrs:rw \
            --net=host \
            srv6d/electrs:0.10.5
        ExecStop=/usr/bin/docker stop electrs
        Restart=always
        RestartSec=5s

        [Install]
        WantedBy=multi-user.target
    - name: esplora.service
      enabled: true
      contents: |
        [Unit]
        Description=Esplora mainnet electrum server
        Requires=bitcoind.service
        Requires=mnt-data.mount

        [Service]
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker rm --force esplora
        ExecStart=/usr/bin/docker run \
            --name esplora \
            --pull always \
            -v /etc/esplora:/etc/esplora:ro \
            -v /mnt/data/esplora:/mnt/data/esplora:rw \
            --net=host \
            blockstream/esplora
        ExecStop=/usr/bin/docker stop esplora
        Restart=always
        RestartSec=5s

        [Install]
        WantedBy=multi-user.target
